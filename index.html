<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Club de Jeux de Société - Catalogue</title>

<style>
body { font-family: Arial, sans-serif; margin: 80px 20px 200px; background:#f4f4f4; }
h1,h2 { color:#333; }
#logo-asso { position:absolute; top:20px; right:20px; max-width:80px; }
#btn-admin { position:absolute; top:20px; left:20px; }

.categorie-section { margin-top:30px; }
.produits-groupe { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:15px; }
.produit { background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.1); }
.prix { font-weight:bold; color:green; }
.rupture { color:red; font-weight:bold; }

.btn-add { background:#007bff; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; }
.btn-add:disabled { background:#ccc; }

.form-options select { width:100%; padding:6px; }
.btn-add-formule { background:#20c997; color:#fff; border:none; padding:8px; width:100%; border-radius:4px; font-weight:bold; }
.btn-add-formule:disabled { background:#ccc; }
</style>
</head>

<body>

<button id="btn-admin">S'identifier</button>

<h1>Bienvenue aux Gardiens du Jeu !</h1>
<hr>

<div id="catalogue-produits"></div>

<script>
let panier = [];
let allProduits = [];

const choixBoissons = [
 { nom:"Coca-Cola", supplement:0 },
 { nom:"Desperados", supplement:1 }
];
const choixNouilles = ["Nouilles poulet","Nouilles boeuf"];
const choixSnacks = ["Twix","Mars"];

const catalogueSimuleAvecOptions = [
 { nom:"Coca-Cola", prix:1, stock:10, catégorie:"Boissons" },

 {
   nom:"Formule Nouille",
   prix:5,
   base_prix:5,
   stock:50,
   catégorie:"Formules Repas",
   options:[
     { nom:"Nouilles", choix:choixNouilles },
     { nom:"Boisson", choix:choixBoissons },
     { nom:"Snack", choix:choixSnacks }
   ]
 }
];

function creerFormulaireOptions(produit) {
 const formId = `form-${produit.nom.replace(/\s/g,'-')}`;
 const prixInitial = produit.base_prix || produit.prix;

 let html = `<form id="${formId}" class="form-options">`;

 produit.options.forEach((opt,i)=>{
   html += `<label>${opt.nom}</label>
   <select onchange="calculerPrix('${formId}',${prixInitial})">
     <option value="">Choisir</option>`;
   opt.choix.forEach(c=>{
     const nom = typeof c==="object"?c.nom:c;
     const sup = typeof c==="object"?c.supplement:0;
     html += `<option value="${nom}" data-supplement="${sup}">${nom}</option>`;
   });
   html += `</select>`;
 });

 html += `<button type="button" id="${formId}-btn" class="btn-add-formule" disabled
 onclick="ajouterFormule('${produit.nom}',${prixInitial},'${formId}',${produit.options.length})">
 Ajouter la formule
 </button></form>`;
 return html;
}

function calculerPrix(formId,base){
 const form=document.getElementById(formId);
 const btn=document.getElementById(`${formId}-btn`);
 const selects=form.querySelectorAll("select");
 let complet=true;
 let prix=base;

 selects.forEach(s=>{
   if(!s.value) complet=false;
   const opt=s.options[s.selectedIndex];
   if(opt) prix+=Number(opt.dataset.supplement||0);
 });

 btn.disabled=!complet;
 btn.setAttribute("onclick",`ajouterFormule('${btn.onclick.arguments?.[0]}',${prix},'${formId}',${selects.length})`);
}

function ajouterFormule(nom,prix,formId,nb){
 const form=document.getElementById(formId);
 const selects=form.querySelectorAll("select");
 let details=[];
 selects.forEach(s=>details.push(s.value));
 if(details.length!==nb) return;

 panier.push({nom,prix,details});
 alert("Formule ajoutée ✅");
 form.reset();
 document.getElementById(`${formId}-btn`).disabled=true;
}

function chargerCatalogue(){
 allProduits=catalogueSimuleAvecOptions;
 const cont=document.getElementById("catalogue-produits");
 cont.innerHTML="";

 const groupes=allProduits.reduce((a,p)=>{(a[p.catégorie]=a[p.catégorie]||[]).push(p);return a;},{});

 for(const cat in groupes){
  cont.innerHTML+=`<h3>${cat}</h3>`;
  const div=document.createElement("div");
  div.className="produits-groupe";

  groupes[cat].forEach(p=>{
   let stockLine = p.options ? "" : `<p>Stock restant : ${p.stock}</p>`;
   let action = p.options ? creerFormulaireOptions(p)
                          : `<button class="btn-add">Ajouter</button>`;

   div.innerHTML += `
   <div class="produit">
    <h4>${p.nom}</h4>
    <p><strong>Prix :</strong> <span class="prix">${p.prix} €</span></p>
    ${stockLine}
    ${action}
   </div>`;
  });
  cont.appendChild(div);
 }
}

chargerCatalogue();
</script>

</body>
</html>
