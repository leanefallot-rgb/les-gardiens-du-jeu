// CODE À INTÉGRER DANS VOTRE FICHIER GOOGLE APPS SCRIPT (.GS)

function doPost(e) {
  // -----------------------------------------------------------
  // 1. Récupération des données du panier (Articles commandés, Nom, Paiement, Total)
  var nomMembre = e.parameter.NomMembre;
  var articlesCommandes = e.parameter.ArticlesCommandes;
  var modePaiement = e.parameter.ModeDePaiement;
  var coutTotal = e.parameter.CoutTotal;

  // 2. Récupération de la liste des articles unitaires à déduire du stock
  var articlesUnitairesJson = e.parameter.ArticlesUnitaires;
  var articlesUnitaires;
  
  try {
    articlesUnitaires = JSON.parse(articlesUnitairesJson);
  } catch (error) {
    Logger.log("Erreur de parsing des articles unitaires: " + error);
    // Si la structure JSON est incorrecte, nous ne mettons pas à jour le stock
    articlesUnitaires = {}; 
  }
  
  // -----------------------------------------------------------
  // A. MISE À JOUR DU STOCK RÉEL
  // -----------------------------------------------------------
  if (articlesUnitaires && Object.keys(articlesUnitaires).length > 0) {
    var feuilleInventaire = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Inventaire"); // <<< ASSUREZ-VOUS QUE LE NOM EST CORRECT
    if (!feuilleInventaire) {
        // Gérer le cas où la feuille n'existe pas
        Logger.log("Feuille 'Inventaire' introuvable.");
    } else {
        var dataRange = feuilleInventaire.getDataRange();
        var values = dataRange.getValues();
        
        // Supposons que votre feuille d'inventaire a le format : [Nom, Catégorie, Prix, Stock]
        var NOM_COL = 1; // 1ère colonne (A)
        var STOCK_COL = 4; // 4ème colonne (D)

        for (var i = 1; i < values.length; i++) { // Commencez à 1 pour ignorer l'en-tête
            var nomProduit = values[i][NOM_COL - 1]; 
            
            if (articlesUnitaires.hasOwnProperty(nomProduit)) {
                var quantiteVendue = articlesUnitaires[nomProduit];
                var stockActuel = values[i][STOCK_COL - 1];
                
                var nouveauStock = stockActuel - quantiteVendue;
                
                // Mettre à jour la valeur dans le tableau temporaire
                values[i][STOCK_COL - 1] = nouveauStock;
            }
        }
        
        // Écrire toutes les valeurs mises à jour en une seule fois
        dataRange.setValues(values);
    }
  }
  
  // -----------------------------------------------------------
  // B. ENREGISTREMENT DE LA TRANSACTION (Dans une autre feuille, "Commandes" par exemple)
  // -----------------------------------------------------------
  var feuilleCommandes = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Commandes"); // <<< AJUSTEZ LE NOM
  if (feuilleCommandes) {
    feuilleCommandes.appendRow([
      new Date(), 
      nomMembre, 
      articlesCommandes, 
      modePaiement, 
      coutTotal
    ]);
  }

  // 3. Retourner la réponse au client
  return ContentService.createTextOutput(
    JSON.stringify({ success: true })
  ).setMimeType(ContentService.MimeType.JSON);
}
