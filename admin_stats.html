<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Statistiques des ventes</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body { font-family: 'Inter', sans-serif; margin: 20px; background-color: #f4f4f4; }
    h1, h2 { color: #333; }
    table { border-collapse: collapse; width: 100%; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; table-layout: fixed; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; word-wrap: break-word; vertical-align: top; }
    th { background-color: #007bff; color: white; font-weight: 600; text-transform: uppercase; }
    #table-commandes thead tr th:nth-child(1), #table-commandes tbody tr td:nth-child(1) { width: 18%; }
    #table-commandes thead tr th:nth-child(2), #table-commandes tbody tr td:nth-child(2) { width: 15%; }
    #table-commandes thead tr th:nth-child(3), #table-commandes tbody tr td:nth-child(3) { width: 37%; }
    #table-commandes thead tr th:nth-child(4), #table-commandes tbody tr td:nth-child(4) { width: 10%; text-align: right; }
    #table-commandes thead tr th:nth-child(5), #table-commandes tbody tr td:nth-child(5) { width: 20%; }
    #table-commandes tbody tr:nth-child(odd) { background-color: #f9f9f9; }

    /* Styles modale remboursement */
    .modal-bg { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
    .modal { background:white; padding:20px; border-radius:8px; width:320px; max-width:90%; }
    .modal h3 { font-size:1.2em; margin-bottom:10px; }
    .modal input, .modal select { width:100%; padding:8px; margin:5px 0 10px 0; border-radius:4px; border:1px solid #ccc; }
    .modal button { padding:8px 12px; border:none; border-radius:4px; cursor:pointer; }
    .btn-close { background:#dc3545; color:white; margin-right:5px; }
    .btn-save { background:#28a745; color:white; }
</style>
</head>
<body>

<div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Admin - Statistiques des ventes</h1>

    <div class="flex gap-4 mb-6">
        <button id="btn-remboursement" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
            üí∏ Remboursement
        </button>
        <button id="btn-retour" onclick="window.location.href='index.html'" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
            ‚Üê Retour
        </button>
    </div>

    <div class="flex flex-wrap gap-4 mb-8">
        <div class="bg-white p-5 rounded-xl shadow-lg flex-1 min-w-[200px]">
            <h2 class="text-xl font-semibold text-gray-700">Total des ventes</h2>
            <p id="total-ventes" class="text-4xl font-extrabold text-blue-600 mt-1">0 ‚Ç¨</p>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-lg flex-1 min-w-[200px]">
            <h2 class="text-xl font-semibold text-gray-700">Nombre de commandes</h2>
            <p id="total-commandes" class="text-4xl font-extrabold text-green-600 mt-1">0</p>
        </div>
    </div>

    <!-- Graphiques et tableau inchang√©s -->
    <h2 class="text-2xl font-semibold mb-4 text-gray-800">D√©tail des commandes</h2>
    <div class="overflow-x-auto">
        <table id="table-commandes">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Membre</th>
                    <th>Articles</th>
                    <th>Total (‚Ç¨)</th>
                    <th>Mode de paiement</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Modal Remboursement -->
<div id="modal-remboursement" class="modal-bg flex">
    <div class="modal">
        <h3>Nouvelle d√©pense / remboursement</h3>
        <input type="text" id="remb-nom" placeholder="Nom membre / b√©n√©ficiaire">
        <input type="text" id="remb-description" placeholder="Description">
        <input type="number" step="0.01" id="remb-montant" placeholder="Montant (‚Ç¨)">
        <select id="remb-mode">
            <option value="">Mode</option>
            <option value="Esp√®ce">Esp√®ce</option>
            <option value="PayPal">PayPal</option>
            <option value="Autre">Autre</option>
        </select>
        <div class="flex justify-end">
            <button class="btn-close" onclick="fermerModal()">Annuler</button>
            <button class="btn-save" onclick="enregistrerRemboursement()">Enregistrer</button>
        </div>
    </div>
</div>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";

// Ouvrir / fermer modale
document.getElementById('btn-remboursement').addEventListener('click', ()=> {
    document.getElementById('modal-remboursement').style.display='flex';
});
function fermerModal() {
    document.getElementById('modal-remboursement').style.display='none';
    document.getElementById('remb-nom').value='';
    document.getElementById('remb-description').value='';
    document.getElementById('remb-montant').value='';
    document.getElementById('remb-mode').value='';
}

// Enregistrer remboursement
async function enregistrerRemboursement() {
    const nom = document.getElementById('remb-nom').value.trim();
    const desc = document.getElementById('remb-description').value.trim();
    const montant = parseFloat(document.getElementById('remb-montant').value);
    const mode = document.getElementById('remb-mode').value;

    if(!nom || !desc || isNaN(montant) || !mode) {
        alert("Veuillez remplir tous les champs correctement.");
        return;
    }

    const formData = new URLSearchParams();
    formData.append('type','remboursement');
    formData.append('NomMembre', nom);
    formData.append('Description', desc);
    formData.append('Montant', montant.toFixed(2));
    formData.append('ModeRemboursement', mode);

    try {
        const res = await fetch(APPS_SCRIPT_URL, { method:'POST', body: formData });
        const data = await res.json();
        if(data.success) {
            alert("Remboursement enregistr√© !");
            fermerModal();
        } else {
            alert("Erreur: " + (data.error || "Impossible d'enregistrer."));
        }
    } catch(e) {
        console.error(e);
        alert("Erreur de connexion.");
    }
}

// Charger stats existantes (inchang√©)
async function chargerStats() {
    try {
        const response = await fetch(APPS_SCRIPT_URL, { method:'POST', body: new URLSearchParams({type:'commandes'}) });
        const commandes = await response.json();
        const KEY_TOTAL='couttotal', KEY_MEMBRE='nommembre', KEY_ARTICLES='articlecommande', KEY_PAIEMENT='modedepaiement', KEY_DATE='datecommande';

        let totalVentes = 0;
        commandes.forEach(c=> totalVentes += parseFloat(c[KEY_TOTAL]||0));
        document.getElementById('total-ventes').textContent = totalVentes.toFixed(2) + " ‚Ç¨";
        document.getElementById('total-commandes').textContent = commandes.length;

        const tbody = document.querySelector('#table-commandes tbody');
        tbody.innerHTML = '';
        commandes.forEach(c => {
            let d = new Date(c[KEY_DATE]);
            let dateStr = !isNaN(d) ? `${d.toLocaleDateString('fr-FR')} ${d.toLocaleTimeString('fr-FR')}` : c[KEY_DATE];
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${dateStr}</td><td>${c[KEY_MEMBRE]||''}</td><td>${c[KEY_ARTICLES]||''}</td><td>${parseFloat(c[KEY_TOTAL]||0).toFixed(2)}</td><td>${c[KEY_PAIEMENT]||''}</td>`;
            tbody.appendChild(tr);
        });

    } catch(e) { console.error("Erreur stats:", e); }
}

chargerStats();
</script>

</body>
</html>
